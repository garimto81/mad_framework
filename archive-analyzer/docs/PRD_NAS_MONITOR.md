# PRD: NAS Auto Sync Monitor

> **Version**: 1.2
> **Created**: 2024-12-08
> **Updated**: 2024-12-08
> **Status**: Approved

---

## 1. 개요

### 1.1 배경

GGP 포커 콘텐츠 팀은 NAS(10.10.100.122)에 18TB+ 규모의 미디어 아카이브를 보유하고 있습니다.
이 아카이브를 OTT 플랫폼(pokervod)에서 스트리밍하기 위해 파일 메타데이터를 동기화해야 합니다.

### 1.2 문제 정의

| 문제 | 영향 |
|------|------|
| NAS 파일 변경 시 수동 동기화 필요 | 운영 부담 증가 |
| 동기화 상태 확인 어려움 | 데이터 정합성 불확실 |
| 에러 발생 시 알림 없음 | 장애 대응 지연 |

### 1.3 목표

**자동화된 NAS-OTT 동기화 시스템의 상태를 실시간 모니터링**

---

## 2. 시스템 아키텍처

### 2.1 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                         NAS Server                               │
│                    (10.10.100.122)                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  /docker/GGPNAs/ARCHIVE/                                │    │
│  │  ├── WSOP/        (파일 추가/삭제/이동 발생)            │    │
│  │  ├── HCL/                                               │    │
│  │  ├── PAD/                                               │    │
│  │  └── ...                                                │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ SMB/CIFS (주기적 스캔)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Archive Analyzer                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │   Scanner    │───▶│  archive.db  │───▶│ SyncService  │       │
│  │  (SMB 스캔)  │    │  (현재 상태) │    │  (동기화)    │       │
│  └──────────────┘    └──────────────┘    └──────────────┘       │
│         │                                        │               │
│         │  ┌─────────────────────────────────────┤               │
│         │  │ 변경 감지:                          │               │
│         │  │ - 추가: archive.db에만 있음 → 등록  │               │
│         │  │ - 삭제: pokervod에만 있음 → 삭제 마킹│               │
│         │  │ - 이동: 경로 변경 감지 → 업데이트   │               │
│         │  └─────────────────────────────────────┘               │
└───────────────────────────────────────────────────┼──────────────┘
                                                    │
                                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      OTT Platform                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  pokervod.db (통합 DB) - 최종 상태                      │    │
│  │  - files: 현재 스트리밍 가능한 파일 목록                │    │
│  │  - 삭제된 파일은 status='deleted' 마킹                  │    │
│  │  - NAS 변경사항이 실시간 반영됨                         │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 동기화 로직

| 상황 | archive.db | pokervod.db | 동작 |
|------|------------|-------------|------|
| **신규 파일** | ✅ 있음 | ❌ 없음 | → INSERT |
| **삭제된 파일** | ❌ 없음 | ✅ 있음 | → DELETE 또는 status='deleted' |
| **이동된 파일** | ✅ 경로 변경 | ✅ 이전 경로 | → UPDATE nas_path |
| **기존 파일** | ✅ 동일 | ✅ 동일 | → SKIP |

### 2.3 용어 정의

| 용어 | 의미 | 파일 |
|------|------|------|
| **Source DB** | NAS 스캔 결과 저장소 | `archive.db` |
| **Target DB** | OTT 플랫폼 마스터 DB | `pokervod.db` |
| **HLS 호환** | 트랜스코딩 없이 스트리밍 가능 | mp4, mov, ts |
| **동기화** | Source → Target 데이터 전송 | sync_files() |

---

## 3. 사용자 및 페르소나

### 3.1 Primary User: 콘텐츠 운영자

| 속성 | 값 |
|------|-----|
| **역할** | 콘텐츠 업로드/관리 |
| **기술 수준** | 비개발자 |
| **핵심 니즈** | "새 파일이 잘 올라갔는지 확인" |
| **Pain Point** | 터미널 명령어 사용 어려움 |

### 3.2 Secondary User: 시스템 관리자

| 속성 | 값 |
|------|-----|
| **역할** | 시스템 모니터링/장애 대응 |
| **기술 수준** | 개발자 |
| **핵심 니즈** | "에러 발생 시 빠른 원인 파악" |
| **Pain Point** | 로그 분산, 상태 확인 번거로움 |

---

## 4. 기능 요구사항

### 4.1 대시보드 (P0 - 필수)

#### 4.1.1 동기화 상태 카드

```
┌─────────────────────────────────────────┐
│  📊 동기화 현황                          │
├─────────────────────────────────────────┤
│                                         │
│  NAS (Source)          OTT (Target)     │
│  ┌─────────┐   ───▶   ┌─────────┐      │
│  │  2,538  │          │  1,803  │      │
│  │  전체   │          │  HLS    │      │
│  └─────────┘          └─────────┘      │
│                                         │
│  마지막 동기화: 2024-12-08 13:30        │
│  상태: ● 정상                           │
│                                         │
└─────────────────────────────────────────┘
```

**표시 항목:**
- NAS 전체 파일 수 (archive.db)
- OTT 등록 파일 수 (pokervod.db, HLS 호환만)
- 마지막 동기화 시간
- 동기화 상태 (정상/진행중/에러)

#### 4.1.2 파일 통계 카드

```
┌─────────────────────────────────────────┐
│  📁 파일 현황                            │
├─────────────────────────────────────────┤
│                                         │
│  카탈로그별 파일 수:                     │
│  ████████████████████ WSOP    1,714     │
│  ████████             HCL       259     │
│  ████                 PAD        89     │
│  ██                   기타       80     │
│                                         │
│  포맷별:                                 │
│  ● HLS 호환 (mp4/mov): 2,280 (91%)      │
│  ○ 변환 필요 (mxf 등):   226 (9%)       │
│                                         │
└─────────────────────────────────────────┘
```

**표시 항목:**
- 카탈로그별 파일 분포 (막대 그래프)
- HLS 호환/비호환 비율
- 총 용량

#### 4.1.3 액션 버튼

| 버튼 | 기능 | 권한 |
|------|------|------|
| **수동 동기화** | 즉시 동기화 트리거 | 운영자 |
| **정합성 검증** | NAS vs DB 비교 | 운영자 |
| **스캔 실행** | NAS 재스캔 | 관리자 |

### 4.2 실시간 로그 (P0 - 필수)

```
┌─────────────────────────────────────────┐
│  📜 실시간 로그                   [Clear]│
├─────────────────────────────────────────┤
│  13:30:15 [INFO] 동기화 시작            │
│  13:30:16 [INFO] 새 파일 발견: 15개     │
│  13:30:20 [INFO] pokervod.db 업데이트   │
│  13:30:21 [INFO] 동기화 완료            │
│  ▮                                      │
└─────────────────────────────────────────┘
```

**요구사항:**
- WebSocket 기반 실시간 스트리밍
- 로그 레벨별 색상 구분 (INFO/WARN/ERROR)
- 최근 1000줄 버퍼

### 4.3 파일 변경 이력 (P1 - 중요)

```
┌───────────────────────────────────────────────────────────────┐
│  📋 최근 변경 이력                                            │
├────────┬─────────────────────────────┬───────────┬───────────┤
│ 이벤트 │ 파일명                       │ 카탈로그  │ 시간      │
├────────┼─────────────────────────────┼───────────┼───────────┤
│ 🆕 추가 │ WSOP_2024_ME_Day1.mp4      │ WSOP      │ 5분 전    │
│ 🆕 추가 │ HCL_EP123_highlight.mp4    │ HCL       │ 1시간 전  │
│ ❌ 삭제 │ old_file.mxf               │ ARCHIVE   │ 2시간 전  │
└────────┴─────────────────────────────┴───────────┴───────────┘
```

### 4.4 설정 (P2 - 선택)

| 설정 항목 | 기본값 | 설명 |
|-----------|--------|------|
| 동기화 간격 | 30분 | 자동 동기화 주기 |
| HLS 필터 | ON | HLS 호환 파일만 동기화 |
| 알림 | OFF | 에러 시 알림 (추후) |

---

## 5. 비기능 요구사항

### 5.1 성능

| 지표 | 목표 |
|------|------|
| 페이지 로드 | < 2초 |
| API 응답 | < 500ms |
| WebSocket 지연 | < 100ms |

### 5.2 가용성

| 환경 | 요구사항 |
|------|----------|
| Docker | 헬스체크, 자동 재시작 |
| Windows | 시스템 트레이, 자동 시작 |

---

## 6. UI 와이어프레임

### 6.1 핵심 설계 원칙: 1:1 매칭 구조

> **핵심 개념**: archive.db가 출발점(Source), pokervod.db가 도착점(Target).
> 파일 단위로 1:1 매칭 상태를 시각화하여 데이터 흐름을 명확히 한다.

#### 매칭 상태 정의

| 상태 | 설명 | 동작 |
|------|------|------|
| ✅ **동기화됨** | archive.db와 pokervod.db 모두 존재 | 유지 |
| ➕ **신규** | archive.db에만 존재 | pokervod에 INSERT |
| 🗑️ **삭제됨** | pokervod.db에만 존재 (NAS에서 삭제됨) | pokervod에서 DELETE 마킹 |
| ⚠️ **중복** | 동일 파일명이 여러 경로에 존재 | 첫 번째만 동기화 |
| ❌ **미등록** | HLS 비호환 (mxf, mkv 등) | 동기화 제외 |

### 6.2 메인 대시보드 - 1:1 매칭 테이블

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🔄 NAS → OTT 동기화 모니터                              ● 정상 동작 중     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  📊 요약: 전체 2,538 → HLS 호환 1,803 (71%) / 중복 509 / 미등록 226        │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  🗂️ 1:1 파일 매칭 현황                              [필터 ▼] [검색]  │ │
│  ├──────┬─────────────────────────────┬─────────────────────────────┬────┤ │
│  │ 상태 │ 📂 Source (archive.db)      │ 📺 Target (pokervod.db)     │ ID │ │
│  ├──────┼─────────────────────────────┼─────────────────────────────┼────┤ │
│  │  ✅  │ WSOP/2024/ME_Day1.mp4       │ WSOP/2024/ME_Day1.mp4       │ 42 │ │
│  │      │ 📁 1.2 GB │ h264 │ 1080p   │ 📁 1.2 GB │ HLS ✓          │    │ │
│  ├──────┼─────────────────────────────┼─────────────────────────────┼────┤ │
│  │  ✅  │ HCL/EP123.mp4               │ HCL/EP123.mp4               │ 85 │ │
│  │ 중복 │ 📁 856 MB │ h264 │ 720p    │ 📁 856 MB │ HLS ✓          │    │ │
│  │      │ ⚠️ +2 중복 경로             │                             │    │ │
│  ├──────┼─────────────────────────────┼─────────────────────────────┼────┤ │
│  │  ❌  │ PAD/Special.mxf             │                             │ -- │ │
│  │      │ 📁 2.5 GB │ prores │ 4K    │ (HLS 비호환)                │    │ │
│  ├──────┼─────────────────────────────┼─────────────────────────────┼────┤ │
│  │  ❌  │ ARCHIVE/old_backup.mkv      │                             │ -- │ │
│  │      │ 📁 4.1 GB │ hevc │ 1080p   │ (확장자 미지원)             │    │ │
│  └──────┴─────────────────────────────┴─────────────────────────────┴────┘ │
│                                                                             │
│  페이지: [1] 2 3 ... 127    파일당 20개 표시                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 트리 뷰 - 카탈로그별 매칭 시각화

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📂 카탈로그 트리 뷰                                    [테이블] [트리 ✓]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  📂 WSOP (1,714 파일)                                                      │
│  ├── 📂 2024                                   Source    →    Target       │
│  │   ├── 📄 ME_Day1_Part1.mp4                  ✅ 1.2GB       ✅ ID:42     │
│  │   ├── 📄 ME_Day1_Part2.mp4                  ✅ 1.1GB       ✅ ID:43     │
│  │   ├── 📄 ME_Day1_Part3.mp4                  ✅ 980MB       ✅ ID:44     │
│  │   └── 📄 ME_Raw.mxf                         ✅ 8.5GB       ❌ 미등록    │
│  │                                                                          │
│  ├── 📂 2023                                                               │
│  │   ├── 📄 ME_Final_Table.mp4                 ✅ 2.3GB       ✅ ID:156    │
│  │   └── 📄 ME_Final_Table.mp4 ⚠️중복          ✅ 2.3GB       -- 중복      │
│  │       └── 원본: /WSOP/2023/Finals/                                      │
│  │                                                                          │
│  📂 HCL (259 파일)                                                         │
│  ├── 📄 EP001_Pilot.mp4                        ✅ 1.8GB       ✅ ID:201    │
│  └── ...                                                                    │
│                                                                             │
│  📂 PAD (89 파일)                                                          │
│  └── ...                                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 대시보드 요약 카드

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌────────┐ │
│  │  📂 Source      │  │  📺 Target      │  │  ⚠️ 제외됨       │  │ 🔄     │ │
│  │  archive.db     │  │  pokervod.db    │  │                 │  │ 동기화 │ │
│  │                 │  │                 │  │                 │  │        │ │
│  │    2,538       │→→│    1,803        │  │  비호환: 226    │  │ [실행] │ │
│  │    전체 파일    │  │    HLS 등록     │  │  중복: 509      │  │        │ │
│  │                 │  │                 │  │                 │  │ 13:30  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.5 용어 수정

| Before (혼란) | After (명확) |
|---------------|--------------|
| Archive DB | NAS 아카이브 (Source) |
| Pokervod DB | OTT 플랫폼 (Target) |
| Manual Sync | 동기화 실행 |
| Reconcile | 정합성 검증 |

---

## 7. API 명세

### 7.1 엔드포인트

| 엔드포인트 | 메서드 | 설명 | 응답 |
|-----------|--------|------|------|
| `/health` | GET | 헬스 체크 | `{status, last_sync}` |
| `/api/dashboard` | GET | 대시보드 요약 | 아래 참조 |
| `/api/matching` | GET | **1:1 매칭 목록** | 아래 참조 |
| `/api/matching/tree` | GET | **트리 구조 매칭** | 아래 참조 |
| `/api/sync` | POST | 동기화 트리거 | `{message, job_id}` |
| `/api/reconcile` | POST | 정합성 검증 | `{result}` |
| `/ws/logs` | WS | 실시간 로그 | 로그 스트림 |

### 7.2 `/api/dashboard` 응답 구조

```json
{
  "source": {
    "name": "NAS 아카이브",
    "db_path": "archive.db",
    "total_files": 2538,
    "by_type": {"video": 2506, "other": 31, "subtitle": 1},
    "db_size_mb": 3.13
  },
  "target": {
    "name": "OTT 플랫폼",
    "db_path": "pokervod.db",
    "total_files": 1803,
    "by_format": {"mp4": 1274, "mov": 529},
    "excluded": {
      "non_hls": 226,
      "duplicates": 509
    }
  },
  "sync_status": {
    "is_running": false,
    "last_sync_time": "2024-12-08T13:30:00",
    "last_result": {"added": 15, "updated": 3, "errors": 0}
  },
  "catalogs": [
    {"id": "WSOP", "count": 1714},
    {"id": "HCL", "count": 259}
  ]
}
```

### 7.3 `/api/matching` 응답 구조 (1:1 매칭 테이블)

```json
{
  "total": 2538,
  "page": 1,
  "per_page": 20,
  "items": [
    {
      "status": "synced",
      "source": {
        "id": 1,
        "path": "WSOP/2024/ME_Day1.mp4",
        "size_bytes": 1288490188,
        "codec": "h264",
        "resolution": "1920x1080",
        "duration_sec": 3600
      },
      "target": {
        "id": 42,
        "nas_path": "WSOP/2024/ME_Day1.mp4",
        "size_bytes": 1288490188,
        "hls_compatible": true
      },
      "duplicates": []
    },
    {
      "status": "synced_with_duplicates",
      "source": {
        "id": 5,
        "path": "HCL/EP123.mp4",
        "size_bytes": 897581056,
        "codec": "h264",
        "resolution": "1280x720"
      },
      "target": {
        "id": 85,
        "nas_path": "HCL/EP123.mp4",
        "hls_compatible": true
      },
      "duplicates": [
        {"id": 6, "path": "HCL/Archive/EP123.mp4"},
        {"id": 7, "path": "HCL/Backup/EP123.mp4"}
      ]
    },
    {
      "status": "not_synced",
      "source": {
        "id": 100,
        "path": "PAD/Special.mxf",
        "size_bytes": 2684354560,
        "codec": "prores",
        "resolution": "3840x2160"
      },
      "target": null,
      "reason": "HLS 비호환 (mxf)"
    }
  ],
  "summary": {
    "synced": 1803,
    "not_synced": 226,
    "duplicates_excluded": 509
  }
}
```

### 7.4 `/api/matching/tree` 응답 구조 (트리 뷰)

```json
{
  "catalogs": [
    {
      "name": "WSOP",
      "total_files": 1714,
      "synced": 1650,
      "not_synced": 64,
      "children": [
        {
          "name": "2024",
          "type": "directory",
          "files": [
            {
              "name": "ME_Day1_Part1.mp4",
              "source_id": 1,
              "target_id": 42,
              "status": "synced",
              "size_bytes": 1288490188
            },
            {
              "name": "ME_Raw.mxf",
              "source_id": 10,
              "target_id": null,
              "status": "not_synced",
              "reason": "HLS 비호환"
            }
          ]
        }
      ]
    },
    {
      "name": "HCL",
      "total_files": 259,
      "synced": 245,
      "not_synced": 14,
      "children": []
    }
  ]
}
```

---

## 8. 기술 스택

### 8.1 프론트엔드 (권장 라이브러리)

| 용도 | 라이브러리 | 선정 이유 |
|------|-----------|----------|
| **트리 뷰** | [react-arborist](https://github.com/brimdata/react-arborist) | VSCode 스타일, 3.5k+ stars |
| **테이블** | [TanStack Table](https://tanstack.com/table/v8) | Headless, 커스텀 자유도 |
| **스타일** | Tailwind CSS | 기존 대시보드와 일관성 |
| **HTTP** | htmx (기존) 또는 fetch | 점진적 개선 |

### 8.2 백엔드

| 용도 | 기술 | 비고 |
|------|------|------|
| **API** | FastAPI | 기존 유지 |
| **DB** | SQLite (archive.db, pokervod.db) | 기존 유지 |
| **실시간** | WebSocket | 기존 로그 스트리밍 유지 |

---

## 9. 구현 우선순위

| Phase | 기능 | 상태 |
|-------|------|------|
| **P0** | 대시보드 기본 (상태, 통계, 로그) | ✅ 완료 |
| **P0** | 동기화/정합성 검증 버튼 | ✅ 완료 |
| **P0** | `/api/dashboard` 통합 API | 🔜 구현 필요 |
| **P1** | `/api/matching` 1:1 매칭 테이블 API | 🔜 구현 필요 |
| **P1** | `/api/matching/tree` 트리 구조 API | 🔜 구현 필요 |
| **P1** | 1:1 매칭 테이블 UI | 🔜 구현 필요 |
| **P1** | 트리 뷰 UI (카탈로그별) | 🔜 구현 필요 |
| **P2** | 파일 변경 이력 (file_history 테이블) | 미정 |
| **P2** | 설정 페이지 | 미정 |

---

## 10. 승인

| 역할 | 이름 | 승인 |
|------|------|------|
| PM | - | ⬜ |
| 개발 | Claude | ⬜ |
| 운영 | - | ⬜ |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0 | 2024-12-08 | 초안 작성 |
| 1.1 | 2024-12-08 | **1:1 매칭 구조 UI 재설계** - 사용자 피드백 반영 |
|     |            | - 6.1 핵심 설계 원칙: 1:1 매칭 구조 추가 |
|     |            | - 6.2 1:1 매칭 테이블 UI 와이어프레임 |
|     |            | - 6.3 트리 뷰 UI (카탈로그별 매칭 시각화) |
|     |            | - 6.4 대시보드 요약 카드 레이아웃 |
|     |            | - 7.3 `/api/matching` API 명세 추가 |
|     |            | - 7.4 `/api/matching/tree` API 명세 추가 |
| 1.2 | 2024-12-08 | **동기화 로직 명확화** |
|     |            | - 2.1 데이터 흐름 다이어그램 개선 |
|     |            | - 2.2 동기화 로직 테이블 추가 (INSERT/DELETE/UPDATE) |
|     |            | - 매칭 상태에 "신규", "삭제됨" 상태 추가 |
