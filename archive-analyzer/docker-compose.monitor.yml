# NAS Auto Sync with Web Monitoring
# Issue #43: Docker 서버 배포 + GUI 모니터링
#
# Usage:
#   docker-compose -f docker-compose.monitor.yml up -d
#   docker-compose -f docker-compose.monitor.yml logs -f
#
# Access:
#   http://localhost:8080 - Web Dashboard

version: "3.8"

services:
  # ==========================================================================
  # Web Monitoring + Sync Service (All-in-One)
  # ==========================================================================
  nas-sync-monitor:
    build:
      context: .
      dockerfile: Dockerfile.monitor
    container_name: nas-sync-monitor
    restart: unless-stopped

    ports:
      - "${WEB_PORT:-8080}:8080"

    environment:
      # DB 경로 (컨테이너 내부)
      - ARCHIVE_DB=/app/data/output/archive.db
      - POKERVOD_DB=/app/data/pokervod.db

      # NAS 마운트 경로 (SMB 마운트 시)
      - NAS_MOUNT_PATH=/nas

      # 동기화 간격 (초)
      - SYNC_INTERVAL=${SYNC_INTERVAL:-1800}

      # 웹 포트
      - WEB_PORT=8080

      # 로그 레벨
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    volumes:
      # 로컬 데이터 디렉토리
      - ${HOST_DATA_DIR:-./data}:/app/data:rw

      # NAS 마운트 (선택 - 호스트에서 마운트한 경우)
      - ${NAS_MOUNT_PATH:-/mnt/nas}:/nas:ro

    # 모드 선택: web, sync, track, all
    command: all

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    networks:
      - nas-sync-network

  # ==========================================================================
  # MeiliSearch (Optional - for search functionality)
  # ==========================================================================
  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: nas-sync-meilisearch
    restart: unless-stopped
    profiles:
      - search

    ports:
      - "7700:7700"

    volumes:
      - meilisearch_data:/meili_data

    environment:
      - MEILI_ENV=${MEILI_ENV:-development}
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-nas-sync-dev-key}
      - MEILI_NO_ANALYTICS=true

    networks:
      - nas-sync-network

volumes:
  meilisearch_data:
    name: nas-sync-meilisearch-data

networks:
  nas-sync-network:
    name: nas-sync-network
